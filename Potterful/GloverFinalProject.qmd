---
title: "Potterful: Aquaculture Data Management"
subtitle: "Tools for Reef Fish Larval Rearing"
author: "Kent Glover"
date: "2024-12-02"
format: 
  revealjs:
    theme: solarized
    transition: slide
    slide-number: true
    preview-links: auto
    logo: "inst/shiny/Potterful/www/potters_angel.jpg" # Optional: ensure path is correct or remove
    footer: "OCN 682 Final Project"
---

## Introduction {background-color="#2c3e50"}

<div style="color: white">
### The Problem
Aquaculture generates massive amounts of messy data, especially in a busy lab with 10 staff members:

-   Daily feedings, Environmental logs, Mortality counts, Growth measurements

### The Solution: `Potterful`
An R package designed to standardise the ingestion, analysis, and visualization of aquaculture data.
</div>

## Package Overview

The `Potterful` package provides:

1.  **Data Ingestion**: Tools to clean messy Excel datasheets.
2.  **Growth Metrics**: Functions for SGR, TGC, and FCR.
3.  **Visualization**: Custom `ggplot2` themes and survival plots.
4.  **Interactive Dashboard**: A built-in Shiny app.

```{r}
#| label: setup
#| include: false

# Load necessary libraries
library(tidyverse)
library(survival)
library(survminer)
library(knitr)

# DEVELOPMENT MODE: Load the package from the current directory
# This ensures it works even if you haven't fully "installed" it yet.
devtools::load_all(".") 
```

## Metric 1: Growth Analysis

We can quickly calculate metrics like **Specific Growth Rate (SGR)** using the package's `calc_sgr()` function.

```{r}
#| echo: true
#| eval: true

# Example: Calculating SGR for a single tank
initial_len <- 1.489 # mm
final_len <- 3.884   # mm
days <- 18

sgr <- calc_sgr(
  final_size = final_len, 
  initial_size = initial_len, 
  days = days
)

paste0("Specific Growth Rate: ", round(sgr, 2), "% per day")
```

## Visualizing Growth

Using the package's custom dataset `pott_growth_data.csv` and `theme_potter()`.

```{r}
#| label: plot-growth
#| echo: true
#| output-location: slide
#| fig-width: 10
#| fig-height: 5

# Load Data (Adjust path if necessary)
growth_df <- read_csv("data-raw/pott_growth_data.csv", show_col_types = FALSE) %>%
  filter(!is.na(length))

# Plot
ggplot(growth_df, aes(x = dph, y = length, color = Protocol)) +
  geom_point(alpha = 0.6) +
  geom_smooth(se = FALSE, method = "loess") +
  labs(title = "Larval Growth by Protocol",
       x = "Days Post Hatch (DPH)",
       y = "Length (mm)") +
  theme_potter() # <--- Using our custom package theme!
```

## Metric 2: Survival Analysis

The package streamlines Kaplan-Meier survival curves using `plot_survival_km()`.

*(Simulated data for demonstration)*

```{r}
#| echo: true
#| output-location: slide

# 1. Create specific Mock Data
mock_survival <- data.frame(
  dph = sample(1:30, 100, replace = TRUE),
  status = sample(c(0, 1), 100, replace = TRUE, prob = c(0.7, 0.3)),
  protocol = sample(c("Protocol A", "Protocol B"), 100, replace = TRUE)
)

# 2. Use the package function
plot_survival_km(
  data = mock_survival,
  time_col = "dph",
  status_col = "status",
  group_col = "protocol"
)
```

## Spawning Performance

Tracking viability over time using `pott_spawn_data.csv`.

```{r}
#| echo: false
#| warning: false
#| fig-width: 10

# Load and clean the spawn data
spawn_df <- read_csv("data-raw/pott_spawn_data.csv", show_col_types = FALSE) %>%
  # Select only the first 5 valid columns to avoid the duplicate/empty ones at the end
  select(1:5) %>%
  # Manually rename to ensure we have the exact names we expect
  set_names(c("date", "viable", "unviable", "total", "viability_percent")) %>%
  mutate(date = mdy(date)) %>%
  filter(!is.na(viability_percent))

# Create the plot
ggplot(spawn_df, aes(x = date, y = viability_percent)) +
  geom_line(color = "#2c3e50") +
  geom_area(fill = "#2c3e50", alpha = 0.2) +
  labs(title = "Spawning Viability (2023-2024)",
       x = "Date",
       y = "Viability (%)") +
  theme_potter()
```

## The Shiny App

`Potterful` includes a bundled Shiny application for exploring this data interactively.

To launch the app:

**Visit** [TheFishLG.shinyapps.io/Potterful](https://thefishlg.shinyapps.io/Potterful/)

### Key Features:

  - Filter data by date range.
  - Compare multiple rearing protocols instantly.
  - Download summary reports.

## Summary

The **Potterful** package simplifies the workflow for aquaculture research.

### Future Development:

  - Add `calc_fcr()` integration for live feeds.
  - Incorporate water quality logs.
  - Publish to CRAN?
