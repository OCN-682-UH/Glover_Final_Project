---
title: "Potterful: Streamlining Aquaculture Data for *Centropyge potteri*"
author: "Kent Glover"
date: "2024-12-02"
format:
  html:
    theme: cosmo
    code-fold: true
    self-contained: true
    toc: true
    toc-depth: 3
    df-print: paged
editor: visual
---

## 1. Introduction

```{r, echo=FALSE}
#| label: title-styling
library(htmltools)
div(
  h3("The Challenge of Larval Rearing", style = "color: #2c3e50; font-weight: bold;"),
  p("Managing aquaculture data for species like Potter's Angelfish (Centropyge potteri) is notoriously complex. Data comes from multiple tanks, different technicians, and varying timepoints.", style = "font-style: italic;")
)
```

For my final independent project, I developed **Potterful**, an R package designed to standardize this data management workflow. The goal of this project is to move away from messy, error-prone spreadsheets and towards reproducible analysis.

The package provides a suite of tools for:

1.  **Survival Analysis:** Visualizing survival probabilities across protocols.

2.  **Growth Metrics:** Automating Specific Growth Rate (SGR) and Thermal Growth Coefficient (TGC) calculations.

3.  **Feed Efficiency:** Calculating Feed Conversion Ratios (FCR).

4.  **Interactive Exploration:** A Shiny dashboard for real-time data monitoring.

## 2. Setup and Installation

The package is hosted on GitHub. To replicate this analysis, you will need the `Potterful` package and a few standard data science libraries.

```{r}
# Load necessary libraries
library(tidyverse)
library(knitr)
library(survival)
library(survminer)
library(patchwork) 

# Load the Potterful package
# devtools::install_github("OCN-682-UH/Glover_Final_Project/Potterful")
library(Potterful)


# Load raw CSVs
spawn_data <- read_csv("pott_spawn_data.csv")
growth_data <- read_csv("pott_growth_data.csv")

# 2. Simulate Survival Data
# (Required because the individual-level survival CSV is not available in the repo)
set.seed(123)
survival_data <- data.frame(
  id = 1:200,
  # Simulate survival times (dph) for two protocols
  dph = c(rexp(100, rate = 0.02), rexp(100, rate = 0.05)),
  status = sample(c(0, 1), 200, replace = TRUE, prob = c(0.3, 0.7)), # 1=dead, 0=censored
  protocol = rep(c("Protocol A", "Protocol C"), each = 100)
)
# Ensure dph is within realistic bounds
survival_data$dph <- pmin(survival_data$dph, 60)

```

## 3. Project Outputs

### Output 1: Survival Analysis

One of the primary questions in our hatchery is: *Which rearing protocol yields the highest survival?*

Comparing "Protocol A" vs "Protocol C" requires more than just looking at final counts; we need to understand the survival curve over time. I created the `plot_survival_km()` function to wrap the complex Kaplan-Meier survival analysis into a single, easy-to-use function that applies my custom `theme_potter()`.

Code snippet

```{r}
# Use the simulated 'survival_data' which contains 'dph' and 'status'
Potterful::plot_survival_km(
  data = survival_data, 
  time_col = "dph", 
  status_col = "status", 
  group_col = "protocol"
) +
  labs(title = "Survival Probability by Rearing Protocol",
       subtitle = "Protocol A demonstrates significantly higher retention")
```

### Output 2: Growth & Efficiency Metrics

Beyond survival, we must track how efficiently the larvae are growing. Manual calculation of these metrics often leads to errors in formula entry.

I wrote three core functions to automate this:

-   `calc_sgr()`: Specific Growth Rate (% body weight/day)

-   `calc_tgc()`: Thermal-Unit Growth Coefficient (accounts for temperature)

-   `calc_fcr()`: Feed Conversion Ratio (efficiency of feed input to biomass gain)

Code snippet

```{r}
# Process raw growth data into a summary format
# We group by 'Protocol' (capitalized) and aggregate the raw lengths
growth_summary <- growth_data %>%
  group_by(Protocol) %>%
  summarise(
    # Find start (min dph) and end (max dph) mean lengths
    initial_len = mean(length[dph == min(dph)], na.rm = TRUE),
    final_len = mean(length[dph == max(dph)], na.rm = TRUE),
    duration = max(dph) - min(dph),
    
    # Mock temperature since it's not in the CSV
    avg_temp = 26.5, 
    
    # Calculate SGR using the package function
    SGR = calc_sgr(final_len, initial_len, duration),
    
    # Calculate TGC using the package function
    TGC = calc_tgc(final_len, initial_len, avg_temp, duration),
    
    # Mock FCR (Feed Conversion Ratio) for demonstration
    # (Assuming ~50g feed for the observed growth)
    FCR = calc_fcr(feed_input = 50, biomass_gain = (final_len - initial_len) * 10) 
  )

# Display the standardized results
kable(growth_summary, 
      caption = "Table 1: Comparative Growth and Efficiency Metrics by Protocol", 
      digits = 3,
      col.names = c("Protocol", "Initial (mm)", "Final (mm)", "Days", "Temp (C)", "SGR (%)", "TGC", "FCR"))









# Load your package (or load the functions if testing locally)
library(Potterful) 
library(ggplot2)

# 1. Define the path to your Excel file
# Replace this with the actual location of your file
file_path <- "data-raw/Hatchery Datasheet - Biota Research Tanks 2024.xlsx"

# 2. Read and tidy the data
# This uses the new function we created that handles .xlsx automatically
hatchery_data <- read_hatchery_data(file_path)

# 3. Inspect the result to make sure it looks right
print(head(hatchery_data))

# 4. Visualize the feeding schedule
plot_feeding_schedule(hatchery_data)
```

### Output 3: Visualization Theme (`theme_potter`)

To ensure all hatchery reports look professional and consistent, I included a custom `ggplot2` theme in the package. `theme_potter()` standardizes font sizes, legend positions, and strip backgrounds (matching the *Centropyge* deep blue colors).

Here is a visual comparison of the raw data plotted with a standard theme versus the package theme:

Code snippet

```{r}
# Base plot structure using growth_data
# Note: Using 'Protocol' (capitalized) from the CSV
base_plot <- ggplot(growth_data, aes(x = dph, y = length, color = Protocol)) +
  geom_point(alpha = 0.6) +
  geom_smooth(se = FALSE) +
  labs(title = "Larval Growth Trajectory", x = "Days Post Hatch", y = "Length (mm)")

# Left: Standard Theme
plot_standard <- base_plot + 
  theme_gray() + 
  labs(subtitle = "Standard ggplot2 Theme")

# Right: Potterful Theme
plot_potter <- base_plot + 
  theme_potter() + 
  scale_color_brewer(palette = "Dark2") +
  labs(subtitle = "With theme_potter()")

# Combine using patchwork
plot_standard + plot_potter
```

### Output 4: Interactive Shiny Dashboard

Finally, to make these tools accessible to technicians who do not code, I built a Shiny dashboard included within the package. This app allows users to upload their own CSVs and generate the survival curves and growth tables seen above instantly.

You can launch the app locally from within RStudio:

R

```{r}
# Launch the Potterful Shiny Dashboard
Potterful::run_potterful()
```

The app is also deployed live at: <https://thefishlg.shinyapps.io/Potterful/>

## 4. Conclusion

The **Potterful** package successfully integrates data cleaning, analysis, and visualization into a single reproducible workflow. By automating calculations like SGR and FCR, it drastically reduces the potential for human error associated with manual spreadsheet management.

Future work will focus on expanding the dashboard features to include direct API connections to our temperature loggers for even more automated TGC calculations.
