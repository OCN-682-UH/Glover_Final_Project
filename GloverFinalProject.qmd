---
title: "Potterful: Streamlining Aquaculture Data for *Centropyge potteri*"
subtitle: "OCN 682 Final Independent Project"
author: "Kent Glover"
date: "2024-12-02"
format:
  html:
    theme: cosmo
    code-fold: true
    code-tools: true
    toc: true
    toc-depth: 3
    df-print: paged
    self-contained: true
---

```{r setup, include=FALSE}
# Global chunk options for clean output
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  fig.width = 10
)

# Load standard libraries
library(tidyverse)
library(here)
library(knitr)
library(survival)
library(survminer)
library(patchwork)
library(kableExtra)

# Load the custom package
# devtools::install_github("OCN-682-UH/Glover_Final_Project/Potterful")
library(Potterful)
```

## 1\. The Story: From Spreadsheet Chaos to Reproducible Science

### The Challenge

Managing aquaculture data for species like **Potter's Angelfish** (*Centropyge potteri*) is notoriously complex. In a busy hatchery environment, data flows from multiple tanks, different technicians, and varying timepoints.

::: {.callout-important}
**The Problem:** Traditional workflows rely on disconnected spreadsheets, leading to calculation errors in critical metrics like feed efficiency and survival rates.
:::

### The Solution: `Potterful`

To solve this, I developed **Potterful**, an R package designed to standardize this workflow. The goal is to move away from error-prone manual entry and towards **reproducible analysis**.

This package provides a suite of **5 custom functions** to automate:

1.  **Survival Visualization:** `plot_survival_km()`
2.  **Growth Metrics:** `calc_sgr()` and `calc_tgc()`
3.  **Efficiency Metrics:** `calc_fcr()`
4.  **Standardized Aesthetics:** `theme_potter()`

-----

## 2\. The Data

To demonstrate the package capabilities, we will use two datasets included in `Potterful`.

::: {.panel-tabset}

### Spawning Data (`spawn_data`)

Tracks the survival status of individual larvae over time across different rearing protocols.

  * **dph:** Days Post Hatch
  * **status:** 1 = Dead, 0 = Censored/Alive
  * **protocol:** Rearing method (e.g., Protocol A vs C)

### Growth Data (`growth_data`)

Aggregated tank-level data used to calculate performance metrics.

  * **tank\_id:** Unique tank identifier
  * **feed\_input\_g:** Total feed given (grams)
  * **biomass\_gain\_g:** Total weight gained by fish (grams)
  * **temp\_c:** Average water temperature
    :::

<!-- end list -->

```{r data-preview}
#| label: preview-data
head(Potterful::spawn_data, 3)
```

-----

## 3\. Analysis Workflow

### Part A: Survival Analysis

*Question: Which rearing protocol yields the highest survival?*

Comparing "Protocol A" vs "Protocol C" requires understanding the survival curve over time, not just final counts. I created `plot_survival_km()` to wrap complex Kaplan-Meier logic into a single function.

```{r survival-plot}
#| label: fig-survival
#| fig.cap: "Figure 1: Kaplan-Meier survival probability. Protocol A demonstrates significantly higher retention through day 30."

Potterful::plot_survival_km(
  data = Potterful::spawn_data, 
  time_col = "dph", 
  status_col = "status", 
  group_col = "protocol"
) +
  labs(
    title = "Survival Probability by Rearing Protocol",
    subtitle = "Analysis generated using Potterful::plot_survival_km()"
  )
```

### Part B: Growth & Efficiency Metrics

Beyond survival, we must track how efficiently the larvae are growing. Manual calculation of these metrics often leads to errors in formula entry. `Potterful` automates this with three vectorized functions:

  * **`calc_sgr()`**: Specific Growth Rate (% body weight/day)
  * **`calc_tgc()`**: Thermal-Unit Growth Coefficient (accounts for temperature)
  * **`calc_fcr()`**: Feed Conversion Ratio (efficiency of feed input to biomass gain)

<!-- end list -->

```{r growth-table}
#| label: tbl-growth-metrics
#| code-fold: show

# Calculate comprehensive summary statistics using package functions
growth_summary <- Potterful::growth_data %>%
  group_by(tank_id, protocol) %>%
  summarise(
    avg_temp = mean(temp_c, na.rm = TRUE),
    
    # --- Custom Package Functions Used Here ---
    SGR = calc_sgr(mean(final_weight), mean(initial_weight), max(days)),
    TGC = calc_tgc(mean(final_weight), mean(initial_weight), temp_c, max(days)),
    FCR = calc_fcr(sum(feed_input_g), sum(biomass_gain_g)),
    # ----------------------------------------
    
    .groups = "drop"
  )

# Display standardized results
growth_summary %>%
  kbl(caption = "Table 1: Comparative Growth and Efficiency Metrics by Tank", digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

-----

## 4\. Visual Standardization (`theme_potter`)

To ensure all hatchery reports look professional and consistent, the package includes `theme_potter()`. It standardizes font sizes, legend positions, and strip backgrounds to match the *Centropyge* deep blue branding.

```{r theme-demo}
#| label: fig-theme-compare
#| fig.height: 5
#| fig.cap: "Figure 2: Comparison of standard ggplot (left) vs. the custom Potterful theme (right)."

# Base plot structure
base_plot <- ggplot(Potterful::growth_data, aes(x = days, y = weight_g, color = tank_id)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(se = FALSE, method = "loess") +
  labs(title = "Larval Growth Trajectory", x = "Days Post Hatch", y = "Weight (g)")

# Left: Standard Theme
plot_standard <- base_plot + 
  theme_gray() + 
  labs(subtitle = "Standard ggplot2 Theme")

# Right: Potterful Theme
plot_potter <- base_plot + 
  theme_potter() + 
  scale_color_brewer(palette = "Dark2") +
  labs(subtitle = "With Potterful::theme_potter()")

# Combine using patchwork
plot_standard + plot_potter
```

-----

## 5\. Democratizing Data: The Shiny App

To make these tools accessible to technicians who do not code, I built a Shiny dashboard included within the package. This allows users to upload raw CSVs and generate the survival curves and growth tables seen above instantly.

**You can launch the app locally via:**

```{r}
Potterful::run_potterful()
```

**Or visit the deployed version:** [TheFishLG.shinyapps.io/Potterful](https://thefishlg.shinyapps.io/Potterful/)

::: {.callout-tip icon=false}

### App Interface

:::

-----

## 6\. Conclusion & Future Work

The **Potterful** package successfully integrates data cleaning, analysis, and visualization into a single reproducible workflow.

  * **Impact:** By automating calculations like SGR and FCR, we drastically reduce the potential for human error.
  * **Future Work:** I plan to connect the dashboard directly to our temperature logger API to automate the `calc_tgc()` inputs.

