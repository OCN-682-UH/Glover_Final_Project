---
title: "Potterful: Streamlining Aquaculture Data for *Centropyge potteri*"
author: "Kent Glover"
date: "2024-12-02"
format:
  html:
    theme: cosmo
    code-fold: true
    self-contained: true
    toc: true
    toc-depth: 3
    df-print: paged
editor: visual
---

## 1. Introduction

```{r, echo=FALSE}
#| label: title-styling
library(htmltools)
div(
  h3("The Challenge of Larval Rearing", style = "color: #2c3e50; font-weight: bold;"),
  p("Managing aquaculture data for species like Potter's Angelfish (Centropyge potteri) is notoriously complex. Data comes from multiple tanks, different technicians, and varying timepoints.", style = "font-style: italic;")
)
```

For my final independent project, I developed **Potterful**, an R package designed to standardize this data management workflow. The goal of this project is to move away from messy, error-prone spreadsheets and towards reproducible analysis.

The package provides a suite of tools for:

1.  **Survival Analysis:** Visualizing survival probabilities across protocols.
2.  **Growth Metrics:** Automating Specific Growth Rate (SGR) and Thermal Growth Coefficient (TGC) calculations.
3.  **Feed Efficiency:** Calculating Feed Conversion Ratios (FCR).
4.  **Interactive Exploration:** A Shiny dashboard for real-time data monitoring.

## 2. Setup and Installation

The package is hosted on GitHub. To replicate this analysis, you will need the `Potterful` package and a few standard data science libraries.

```{r setup, echo=TRUE, message=FALSE, warning=FALSE}
# Load necessary libraries
library(tidyverse)
library(here)
library(knitr)
library(survival)
library(survminer)
library(patchwork)
library(ggplot2)
library(dplyr)

# Install the Potterful package from GitHub if not already installed

# If developing locally:
# devtools::install_github("OCN-682-UH/Glover_Final_Project/Potterful")
library(Potterful)
devtools::load_all("Potterful") 

# If installed:
library(Potterful)

```

## 3. Project Outputs

### Output 1: Survival Analysis

One of the primary questions in our hatchery is: *Which rearing protocol yields the highest survival?*

Comparing "Protocol A" vs "Protocol C" requires more than just looking at final counts; we need to understand the survival curve over time. I created the `plot_survival_km()` function to wrap the complex Kaplan-Meier survival analysis into a single, easy-to-use function that applies my custom `theme_potter()`.

```{r survival-plot, echo=TRUE, message=FALSE, warning=FALSE, fig.cap="Figure 1: Kaplan-Meier survival probability showing distinct performance differences between rearing protocols."}
# Use the package dataset 'pott_spawn_data'
# We are comparing survival based on the 'protocol' grouping column
Potterful::plot_survival_km(
  data = Potterful::spawn_data, 
  time_col = "dph", 
  status_col = "status", 
  group_col = "protocol"
) +
  labs(title = "Survival Probability by Rearing Protocol",
       subtitle = "Protocol A demonstrates significantly higher retention through day 30")
```

### Output 2: Growth & Efficiency Metrics

Beyond survival, we must track how efficiently the larvae are growing. Manual calculation of these metrics often leads to errors in formula entry.

I wrote three core functions to automate this:

-   `calc_sgr()`: Specific Growth Rate (% body weight/day)
-   `calc_tgc()`: Thermal-Unit Growth Coefficient (accounts for temperature)
-   `calc_fcr()`: Feed Conversion Ratio (efficiency of feed input to biomass gain)

<!-- end list -->

```{r growth-table, echo=TRUE, message=FALSE}
#| label: growth-metrics-table

#Calculate comprehensive summary statistics
growth_summary <- Potterful::growth_data %>%
  group_by(tank_id, protocol) %>%
  summarise(
    avg_temp = mean(temp_c, na.rm = TRUE),
    #Use package functions for calculations
    SGR = calc_sgr(mean(final_weight), mean(initial_weight), max(days)),
    TGC = calc_tgc(mean(final_weight), mean(initial_weight), temp_c, max(days)),
    FCR = calc_fcr(sum(feed_input_g), sum(biomass_gain_g)),
    .groups = "drop"
  )

#Display the standardized results
kable(growth_summary, 
      caption = "Table 1: Comparative Growth and Efficiency Metrics by Tank", 
      digits = 3,
      col.names = c("Tank ID", "Protocol", "Avg Temp (Â°C)", "SGR (%)", "TGC", "FCR"))
```

### Output 3: Visualization Theme (`theme_potter`)

To ensure all hatchery reports look professional and consistent, I included a custom `ggplot2` theme in the package. `theme_potter()` standardizes font sizes, legend positions, and strip backgrounds (matching the *Centropyge* deep blue colors).

Here is a visual comparison of the raw data plotted with a standard theme versus the package theme:

```{r theme-demo, echo=TRUE, fig.height=4, fig.width=10, fig.cap="Figure 2: Comparison of standard ggplot (left) vs. theme_potter (right)."}
# Base plot structure
base_plot <- ggplot(Potterful::growth_data, aes(x = days, y = weight_g, color = tank_id)) +
  geom_point(alpha = 0.6) +
  geom_smooth(se = FALSE) +
  labs(title = "Larval Growth Trajectory", x = "Days Post Hatch", y = "Weight (g)")

# Left: Standard Theme
plot_standard <- base_plot + 
  theme_gray() + 
  labs(subtitle = "Standard ggplot2 Theme")

# Right: Potterful Theme
plot_potter <- base_plot + 
  theme_potter() + 
  scale_color_brewer(palette = "Dark2") +
  labs(subtitle = "With theme_potter()")

# Combine using patchwork
plot_standard + plot_potter
```

### Output 4: Interactive Shiny Dashboard

Finally, to make these tools accessible to technicians who do not code, I built a Shiny dashboard included within the package. This app allows users to upload their own CSVs and generate the survival curves and growth tables seen above instantly.

You can launch the app locally from within RStudio:

```{r}
# Launch the Potterful Shiny Dashboard
Potterful::run_potterful()
```

The app is also deployed live at: <https://thefishlg.shinyapps.io/Potterful/>

## 4. Conclusion

The **Potterful** package successfully integrates data cleaning, analysis, and visualization into a single reproducible workflow. By automating calculations like SGR and FCR, it drastically reduces the potential for human error associated with manual spreadsheet management.

Future work will focus on expanding the dashboard features to include direct API connections to our temperature loggers for even more automated TGC calculations.
